"use strict";

module.exports = function (eth) {
  return function (txHash, callback) {
    var count = 0;

    var timeout = eth.options.timeout || 800000;
    var interval = eth.options.interval || 7000;
    var noop = function noop() {};
    var cb = callback || noop;

    return new Promise(function (resolve, reject) {
      var txInterval = setInterval(function () {
        eth.getTransactionReceipt(txHash, function (err, result) {
          if (err) {
            clearInterval(txInterval);
            cb(err, null);
            reject(err);
          }

          if (!err && result) {
            clearInterval(txInterval);
            cb(null, result);
            resolve(result);
          }
        });

        if (count >= timeout) {
          clearInterval(txInterval);
          var errMessage = "Receipt timeout waiting for tx hash: " + txHash;
          cb(errMessage, null);
          reject(errMessage);
        }

        count += interval;
      }, interval);
    });
  };
};